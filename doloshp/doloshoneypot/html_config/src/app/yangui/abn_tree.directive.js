define(["app/yangui/yangui.module"],function(e){e.register.directive("abnTree",["$timeout",function(e){return{restrict:"E",templateUrl:"src/app/yangui/abn-tree.tpl.html",replace:!0,scope:{treeData:"=",onSelect:"&",initialSelection:"@",treeControl:"="},link:function(t,n,r){var i,s,o,u,a,f,l,c,h,p,d;i=function(e){return console.log("ERROR:"+e),void 0},r.iconExpand==null&&(r.iconExpand="icon-plus  glyphicon glyphicon-plus  fa fa-plus"),r.iconCollapse==null&&(r.iconCollapse="icon-minus glyphicon glyphicon-minus fa fa-minus"),r.iconLeaf==null&&(r.iconLeaf="icon-file  glyphicon glyphicon-file  fa fa-file"),r.expandLevel==null&&(r.expandLevel="3"),o=parseInt(r.expandLevel,10);if(!t.treeData){console.warn("no treeData defined for the tree!");return}if(t.treeData.length==null){if(treeData.label==null){console.warn("treeData should be an array of root branches");return}t.treeData=[treeData]}a=function(e){var n,r,i,s,o,u;n=function(t,r){var i,s,o,u,a;e(t,r);if(t.children!=null){u=t.children,a=[];for(s=0,o=u.length;s<o;s++)i=u[s],a.push(n(i,r+1));return a}},o=t.treeData,u=[];for(i=0,s=o.length;i<s;i++)r=o[i],u.push(n(r,1));return u},p=null,h=function(n){if(!n){p!=null&&(p.selected=!1),p=null;return}if(n!==p){p!=null&&(p.selected=!1),n.selected=!0,p=n,s(n);if(n.onSelect!=null)return e(function(){return n.onSelect(n)});if(t.onSelect!=null)return e(function(){return t.onSelect({branch:n})})}},t.user_clicks_branch=function(e){if(e!==p)return h(e)},f=function(e){var t;return t=void 0,e.parent_uid&&a(function(n){if(n.uid===e.parent_uid)return t=n}),t},u=function(e,t){var n;n=f(e);if(n!=null)return t(n),u(n,t)},s=function(e){return u(e,function(e){return e.expanded=!0})},t.expandedTree=!1,t.expand_collapse_all_items=function(){var e=t.expandedTree?!1:!0;t.tree_rows.forEach(function(t){t.branch.expanded=e}),t.expandedTree=!t.expandedTree},t.collapse_others=function(){var e=null,n=function(e){e&&t.tree_rows.forEach(function(t){t.branch.uid===e&&(t.branch.expanded=!0,e=t.branch.parent_uid,e&&n(e))})};t.tree_rows.forEach(function(t){t.branch.selected&&(e=t.branch.parent_uid),t.branch.expanded=t.branch.selected?t.branch.expanded:!1}),e&&n(e)},t.tree_rows=[],c=function(){var e,n,i,s,o,u;a(function(e,t){if(!e.uid)return e.uid=""+Math.random()}),a(function(e){var t,n,r,i,s;if(angular.isArray(e.children)){i=e.children,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t.parent_uid=e.uid);return s}}),t.tree_rows=[],a(function(e){var t,n;if(!e.children)return e.children=[];if(e.children.length>0)return n=function(e){return typeof e=="string"?{label:e,children:[]}:e},e.children=function(){var r,i,s,o;s=e.children,o=[];for(r=0,i=s.length;r<i;r++)t=s[r],o.push(n(t));return o}()}),e=function(n,i,s){var o,u,a,f,l,c,h;i.expanded==null&&(i.expanded=!1),!i.children||i.children.length===0?a=r.iconLeaf:i.expanded?a=r.iconCollapse:a=r.iconExpand,t.tree_rows.push({level:n,branch:i,label:i.label,tree_icon:a,visible:s});if(i.children!=null){c=i.children,h=[];for(f=0,l=c.length;f<l;f++)o=c[f],u=s&&i.expanded,h.push(e(n+1,o,u));return h}},o=t.treeData,u=[];for(i=0,s=o.length;i<s;i++)n=o[i],u.push(e(1,n,!0));return u},t.$watch("treeData",c,!0),r.initialSelection!=null&&a(function(t){if(t.label===r.initialSelection)return e(function(){return h(t)})}),l=t.treeData.length,a(function(e,t){return e.level=t,e.expanded=e.level<o});if(t.treeControl!=null&&angular.isObject(t.treeControl))return d=t.treeControl,d.expand_all=function(){return a(function(e,t){return e.expanded=!0})},d.collapse_all=function(){return a(function(e,t){return e.expanded=!1})},d.get_first_branch=function(){l=t.treeData.length;if(l>0)return t.treeData[0]},d.select_first_branch=function(){var e;return e=d.get_first_branch(),d.select_branch(e)},d.get_selected_branch=function(){return p},d.get_parent_branch=function(e){return f(e)},d.select_branch=function(e){return h(e),e},d.get_children=function(e){return e.children},d.select_parent_branch=function(e){var t;e==null&&(e=d.get_selected_branch());if(e!=null){t=d.get_parent_branch(e);if(t!=null)return d.select_branch(t),t}},d.add_branch=function(e,n){return e!=null?(e.children.push(n),e.expanded=!0):t.treeData.push(n),n},d.add_root_branch=function(e){return d.add_branch(null,e),e},d.expand_branch=function(e){e==null&&(e=d.get_selected_branch());if(e!=null)return e.expanded=!0,e},d.collapse_branch=function(e){e==null&&(e=p);if(e!=null)return e.expanded=!1,e},d.get_siblings=function(e){var n,r;e==null&&(e=p);if(e!=null)return n=d.get_parent_branch(e),n?r=n.children:r=t.treeData,r},d.get_next_sibling=function(e){var t,n;e==null&&(e=p);if(e!=null){n=d.get_siblings(e),l=n.length,t=n.indexOf(e);if(t<l)return n[t+1]}},d.get_prev_sibling=function(e){var t,n;e==null&&(e=p),n=d.get_siblings(e),l=n.length,t=n.indexOf(e);if(t>0)return n[t-1]},d.select_next_sibling=function(e){var t;e==null&&(e=p);if(e!=null){t=d.get_next_sibling(e);if(t!=null)return d.select_branch(t)}},d.select_prev_sibling=function(e){var t;e==null&&(e=p);if(e!=null){t=d.get_prev_sibling(e);if(t!=null)return d.select_branch(t)}},d.get_first_child=function(e){var t;e==null&&(e=p);if(e!=null&&((t=e.children)!=null?t.length:void 0)>0)return e.children[0]},d.get_closest_ancestor_next_sibling=function(e){var t,n;return t=d.get_next_sibling(e),t!=null?t:(n=d.get_parent_branch(e),d.get_closest_ancestor_next_sibling(n))},d.get_next_branch=function(e){var t;e==null&&(e=p);if(e!=null)return t=d.get_first_child(e),t!=null?t:(t=d.get_closest_ancestor_next_sibling(e),t)},d.select_next_branch=function(e){var t;e==null&&(e=p);if(e!=null){t=d.get_next_branch(e);if(t!=null)return d.select_branch(t),t}},d.last_descendant=function(e){var t;return e==null,l=e.children.length,l===0?e:(t=e.children[l-1],d.last_descendant(t))},d.get_prev_branch=function(e){var t,n;e==null&&(e=p);if(e!=null)return n=d.get_prev_sibling(e),n!=null?d.last_descendant(n):(t=d.get_parent_branch(e),t)},d.select_prev_branch=function(e){var t;e==null&&(e=p);if(e!=null){t=d.get_prev_branch(e);if(t!=null)return d.select_branch(t),t}}}}}])});