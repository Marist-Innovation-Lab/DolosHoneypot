/*!
 * FooTable Editable Plugin - Awesome Responsive FooTables That Are Editable
 * Version : 0.1
 * Author: Jake Drew - http://www.jakemdrew.com
 *
 * Requires jQuery - http://jquery.com/
 * Requires FooTable http://themergency.com/footable
 *
 * FooTable Editable Copyright 2013 Jake Drew
 *
 * Released under the MIT license
 * You are free to use FooTable Editable in commercial projects as long as this copyright header is left intact.
 *
 * Date: 2 Jul 2013
 */

(function(e,t,n){function i(t){e(t).find("th").each(function(t){e(this).hasClass("fooEditable")&&(t+=1,e("td:nth-child("+t+")").attr("contentEditable",!0))})}function s(r){var i=e.data(t.footable,e(r).attr("id")+"_buttonIndexes");return i===n&&(i={},i.addCols=new Array,i.deleteCols=new Array,i.buttonCols=new Array,i.buttonColCt=0,e(r).find("th").each(function(t){var r=e(this).attr("data-ft-buttons");r!=n&&(i.buttonCols.push(t),r.indexOf("Add")>=0&&i.addCols.push(t),r.indexOf("Delete")>=0&&i.deleteCols.push(t),i.buttonColCt++)}),e.data(t.footable,e(r).attr("id")+"_buttonIndexes",i)),i}function o(t){var r=s(t);r!=n&&e(this).is(":visible")&&e(t).find("tr").not(":first, .footable-row-detail").each(function(){u(this,r)})}function u(t,n){e(t).hasClass("fooNewRecord")?e(n.addCols).each(function(r){e(t).find("td").eq(n.addCols[r]).length>0?e(t).find("td").eq(n.addCols[r]).each(function(){e(this).find('input[type="button"][value="Add"]').length<=0&&e(this).append('<input class="footableButton" type="button" value="Add" />')}):e(t).append('<td><input class="footableButton" type="button" value="Add" /></td>')}):e(n.deleteCols).each(function(r){e(t).find("td").eq(n.deleteCols[r]).length>0?e(t).find("td").eq(n.deleteCols[r]).each(function(){e(this).find('input[type="button"][value="Delete"]').length<=0&&e(this).append('<input class="footableButton" type="button" value="Delete" />')}):e(t).append('<td><input class="footableButton" type="button" value="Delete" /></td>')})}function a(t,n){var r=e(t).prev(),i=e(t).find(".footable-row-detail-inner"),s=e(r).find('input[type="button"][value="Add"].footableButton').is(":visible"),o=e(r).find('input[type="button"][value="Delete"].footableButton').is(":visible"),u=e(r).hasClass("fooNewRecord");r.hasClass("fooNewRecord")?!s&&n.addCols.length>=0&&e(i).find('input[type="button"][value="Add"]').length<=0&&(e(i).append('<input class="footableButton" type="button" value="Add" />'),e(i).find('input[type="button"][value="Delete"].footableButton').remove()):!u&&!o&&n.deleteCols.length>=0&&e(i).find('input[type="button"][value="Delete"]').length<=0&&(e(i).append('<input class="footableButton" type="button" value="Delete" />'),e(i).find('input[type="button"][value="Add"].footableButton').remove())}function f(r,i){var s=e(r).closest("table").attr("id"),o=v(r);if(e(o).hasClass("fooNewRecord")&&e(r).attr("type")!="button")return;var u={};u.command=i,u.table=e.data(t.footable,s+"_serverTableName");if(i=="Load"){l(r,u);return}e(o).find("td").each(function(){var r=e.data(t.footable,s+"_colNames")[e(this).index()],o=e(this).is(":visible"),a=e.data(t.footable,s+"_colControlType")[e(this).index()],f=e.data(t.footable,s+"_idColIndexes").indexOf(e(this).index())>=0;if(i=="Add"||f)if(a===n)u[r]=e(this).text().trim();else{var l=e(this).find("input").val().trim();l!="true"&&(l="false"),u[r]=l}});if(i=="Update"){var a=e.data(t.footable,s+"_colNames")[e(r).index()],f,c=e.data(r,"oldValue");if(e(r).is("input[type='text']"))a=e(r).closest("div").text().trim().slice(0,-1),f=e(r).val();else if(e.data(t.footable,s+"_colControlType")[e(r).index()]!==n){var h=e(r).find("input"),p=h.val();p!="true"&&(p="false"),f=p,c=!p}else f=e(r).text();u.updatedFieldName=a,u.updatedFieldValue=f,u.updatedFieldOldValue=c}l(r,u)}function l(r,i){var s=e(r).closest("table").attr("id"),o=e.data(t.footable,s+"_dataHandlerURL");if(o=="")return;if(o=="demo"||i===n){alert("Demo Mode:\r\nThe following JSON data would be sent to the server: \r\n"+JSON.stringify(i));var u={};u.response="Success",u.message="Your message here",u.data=n,alert("Demo Mode:\r\nThe server responded: \r\n"+JSON.stringify(u)),h(r,JSON.stringify(u),i);return}e.ajax({type:"POST",url:e.data(t.footable,s+"_dataHandlerURL"),contentType:"application/json; charset=uft-8",data:JSON.stringify(i)}).done(function(e){h(r,e,i)}).fail(function(e){alert("error: "+JSON.stringify(e.responseText))})}function c(e){try{p=JSON.parse(e),e=p}catch(t){}finally{return e}}function h(n,r,i){r=c(r),r.responseData=c(r.responseData);var o=e(n).closest("table"),f=v(n),l=e(f).next();e(n).hasClass("footableButton")&&r.response!="Error"&&(i.command=="Add"&&(e(f).removeClass("fooNewRecord"),e(f).find('input[type="button"][value="Add"].footableButton').remove(),u(f,s(o)),e(l).hasClass("footable-row-detail")&&a(l,s(this)),e(f).hasClass("footable-detail-show")&&(e(f).removeClass("footable-detail-show"),e(l).hide())),i.command=="Delete"&&r.response=="Success"&&y(f));if(r.response!="Success")if(r.response=="Load")b(o),E(o,r.responseData);else if(r.response=="Append")E(o,r.responseData);else if(r.response=="Update")g(f,r.responseData);else if(r.response=="Delete")y(f);else if(r.response=="DeleteAll")b(o);else if(r.response=="Error"){alert("The update was not successful\r\n"+r.message);if(i.command=="Update"){var h=e.data(t.footable,e(ft.table).attr("id")+"_colNames").indexOf(i.updatedFieldName);e(n).closest("tr").find("td").eq(h).text(i.updatedFieldOldValue)}}else alert("Invalid server response! Response recieved: "+r.response);w(o)}function v(t){var n=e(t).closest("tr");return e(n).hasClass("footable-row-detail")&&(n=e(n).prev()),n}function g(n,r){var i=e(n).closest("table"),s=e(n).find("td");e.each(r,function(n,r){var o=e.data(t.footable,e(i).attr("id")+"_colNames").indexOf(n);o!=-1&&e(s).eq(o).text(r)})}function y(t){e(t).next().hasClass("footable-row-detail")&&e(t).next().remove(),e(t).prev().hasClass("footable-detail-show")&&e(t).prev().remove(),e(t).remove()}function b(t){e(t).find("tbody > tr").not(".fooNewRecord").remove()}function w(n){if(e(n).find(".fooNewRecord").length>0)return;if(e.data(t.footable,e(n).attr("id")+"_fooNewRecord").length<=0)return;var r=e.data(t.footable,e(n).attr("id")+"_fooNewRecord").clone(!0,!0),i=e(n).find("th");e(r).find("td").each(function(t){e(i[t]).is(":visible")||e(this).hide()}),e(n).find("tbody").append(r)}function E(r,u){if(u===n)return;var a=e(r).find("th"),f="",l=s(r),c=e(r).data("ft");e(u).each(function(){var i="<tr>",s=0;e.each(this,function(o,u){var f=a.eq(s).attr("data-return-type");if(f!=n){var l=c.options.parsers[f];u=l(u)}var h=e.data(t.footable,e(r).attr("id")+"_colControlType")[s];h!=n&&(u=="true"||u==1?u='<input type="checkbox" checked="checked" />':u='<input type="checkbox" />');var p="",d=e(a).eq(s).attr("data-class");d!==n&&(p=' class="'+d+'" ');var v="";e(a).eq(s).is(":visible")||(v=' style="display:none;" '),i+="<td"+p+v+">"+u+"</td>",s++}),e(l.buttonColCt).each(function(){i+="<td></td>"}),i+="</tr>",f+=i}),e(r).find("tbody").prepend(f),o(r),i(r),e(r).data("ft").bindToggleSelectors(),e(r).data("ft").resize()}function S(){var n=this;n.name="Footable Editable",n.init=function(n){e(n.table).data("ft",n);var r=e(n.table).attr("id");e.data(t.footable,r+"_dataHandlerURL",n.options.dataHandlerURL),e.data(t.footable,r+"_serverTableName",n.options.serverTableName),e.data(t.footable,r+"_autoLoad",n.options.autoLoad),e(n.table).bind({footable_initialized:function(i){var o=new Array,u=new Array,a=new Array,l=new Array;e(n.table).find("th").each(function(t){var n=e(this).text().trim();u.push(n),e(this).hasClass("fooEditable")&&a.push(n),e(this).hasClass("fooId")&&o.push(t),l.push(e(this).attr("data-ft-control"))}),e.data(t.footable,r+"_colNames",u),e.data(t.footable,r+"_idColIndexes",o),e.data(t.footable,r+"_fooEditableCols",a),e.data(t.footable,r+"_fooNewRecord",e(n.table).find(".fooNewRecord").clone(!0,!0)),e.data(t.footable,r+"_colControlType",l),e(n.table).on("change",'input[type="checkbox"]',function(t){var n=e(this).is(":checked");e(this).val(n),n?this.setAttribute("checked","checked"):this.removeAttribute("checked"),e(this).parent().trigger("td-cell-changed")}),e(n.table).on("focus","td",function(){e.data(this,"oldValue",e(this).text())}),e(n.table).on("blur","td",function(t){e(this).text()!=e.data(this,"oldValue")&&e(this).trigger("td-cell-changed")}),e(n.table).bind("td-cell-changed",function(t){var n=s(this);n.buttonCols.indexOf(e(t.target).index())<0&&f(t.target,"Update")}),e(n.table).on("focus","input",function(t){e.data(this,"oldValue",e(this).val())}),e(n.table).on("change","input",function(r){if(e(r.target).closest("tr").hasClass("footable-row-detail")){var i=e(r.target).closest("div").text().trim().slice(0,-1),s=e.data(t.footable,e(n.table).attr("id")+"_colNames").indexOf(i);e(r.target).closest("tr").prev().find("td").eq(s).text(e.data(r.target,"oldValue")).text(e(r.target).val()),f(r.target,"Update")}}),e(n.table).on("click",'input[type="button"][value="Add"].footableButton',function(e){f(e.target,"Add")}),e(n.table).on("click",'input[type="button"][value="Delete"].footableButton',function(e){f(e.target,"Delete")})}}),i(n.table),o(n.table),e.data(t.footable,e(n.table).attr("id")+"_autoLoad")&&f(n.table,"Load"),e(n.table).on("click","tr",function(){e(this).hasClass("footable-row-detail")||e(this).trigger("fooDetail-Populated")}),e(n.table).bind("fooDetail-Populated",function(t){a(e(t.target).next(),s(this))})}}if(t.footable==n||t.footable==null)throw new Error("Please check and make sure footable.js is included in the page and is loaded prior to this script.");var r={serverTableName:n,dataHandlerURL:"demo",autoLoad:!1,createDetail:function(n,r){var i={_none:{name:null,data:[]}};for(var s=0;s<r.length;s++){var o=r[s].group;o!=null?(o in i||(i[o]={name:r[s].groupName,data:[]}),i[o].data.push(r[s])):i._none.data.push(r[s])}var u=e(n).closest("table");for(var a in i){if(i[a].data.length==0)continue;a!="_none"&&n.append("<h4>"+i[a].name+"</h4>");for(var f=0;f<i[a].data.length;f++){var l=i[a].data[f].name?":":"",c="<td>"+i[a].data[f].display+"</td>";e(c).children().length>0?n.append("<div><strong>"+i[a].data[f].name+"</strong>"+l+" "+i[a].data[f].display+"</div>"):e.data(t.footable,e(u).attr("id")+"_fooEditableCols").indexOf(i[a].data[f].name)>=0?n.append("<div><strong>"+i[a].data[f].name+"</strong>"+l+' <input type="text" value="'+i[a].data[f].display+'"/></div>'):n.append("<div><strong>"+i[a].data[f].name+"</strong>"+l+' <input type="text" readonly value="'+i[a].data[f].display+'"/></div>')}}e(n).text()==""&&(e(n).closest("tr").prev().removeClass("footable-detail-show"),e(n).closest("tr").remove())},parsers:{numeric:function(t){var n=e(t).data("value")||e(t).text().replace(/[^0-9.-]/g,"");return n=parseFloat(n),isNaN(n)&&(n=0),n},JSONDate:function(e){return String(e).substring(0,6)=="/Date("&&(dt=new Date(parseInt(String(e).substring(6))),d=dt.getDate(),m=dt.getMonth()+1,yy=dt.getFullYear(),e=m+"/"+d+"/"+yy),e},prettyDate:function(e){var t=Date.parse(e);return isNaN(t)==0&&(t=new Date(t),d=t.getDate(),m=t.getMonth(),yy=t.getFullYear(),e=m+"/"+d+"/"+yy),e}}};e.fn.ftEditable=function(e){var t={};return t.processCommand=f,t.transportData=l,t.processServerResponse=h,t.updateRow=g,t.deleteRow=y,t.deleteAllRows=b,t.checkNewEmptyRecord=w,t.addRows=E,t},t.footable.plugins.register(S,r)})(jQuery,window);